<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deno KV Explorer</title>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body class="container">
    <h1>Deno KV Explorer</h1>
    <div id="result" class="editor"></div>
    <div class="button-group">
      <button id="save-button" class="btn-primary">Save</button>
      <button id="delete-button" class="btn-danger">Delete</button>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.37.0/ace.min.js"
      integrity="sha512-ir9JaQR8EgducDjvBjP9spPK+QWvlQDRv3vWn8c1+PAd2+W1wswCI2XDGJSr8V7s3wS/8bKnvK86tNtLbTapdQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="module">
      import {
        decodeKvKey,
        encodeKvKey,
        kvKeyToUrlParam,
        urlParamToKvKey,
      } from "/key-encoding.js";
      import {
        apiRequest,
        checkCredentials,
        getHeaders,
        requireCredentials,
      } from "/credentials.js";

      if (requireCredentials(document.body)) {
        const params = new URLSearchParams(location.search);
        const key = params.get("key") || "";
        const kvKey = urlParamToKvKey(key);
        const editor = ace.edit("result");

        editor.session.setMode("ace/mode/json");
        editor.setShowPrintMargin(false);

        apiRequest("/get?key=" + kvKeyToUrlParam(kvKey))
          .then((res) => res.json())
          .then((entry) => {
            const value = entry.value;
            const formatted = JSON.stringify(value, null, 2);
            editor.setValue(formatted);
            editor.clearSelection();
          });

        function save() {
          const saveButton = document.querySelector("#save-button");
          saveButton.textContent = "Saving...";
          const data = JSON.parse(editor.getValue());

          apiRequest("/set?key=" + kvKeyToUrlParam(kvKey), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }).then(() => {
            saveButton.textContent = "Save";
          }).catch(() => {
            alert("Failed to save data");
            saveButton.textContent = "Save";
          });
        }

        function deleteEntry() {
          if (
            confirm(
              "Are you sure you want to delete this entry? This action cannot be undone.",
            )
          ) {
            const deleteButton = document.querySelector(
              "#delete-button",
            );
            deleteButton.textContent = "Deleting...";
            deleteButton.disabled = true;

            apiRequest("/delete?key=" + kvKeyToUrlParam(kvKey), {
              method: "DELETE",
            }).then((response) => {
              if (response.ok) {
                alert("Entry deleted successfully");
                window.location.href = "/";
              } else {
                throw new Error("Delete failed");
              }
            }).catch(() => {
              alert("Failed to delete entry");
              deleteButton.textContent = "Delete";
              deleteButton.disabled = false;
            });
          }
        }

        document.getElementById("save-button").addEventListener(
          "click",
          save,
        );
        document.getElementById("delete-button").addEventListener(
          "click",
          deleteEntry,
        );
      }
    </script>
  </body>
</html>
